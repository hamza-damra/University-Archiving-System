<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Functionality Test - File Preview System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .test-result {
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
        }
        .test-pass {
            background-color: #d1fae5;
            color: #065f46;
        }
        .test-fail {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Search Functionality Test</h1>
        <p class="text-gray-600 mb-8">Testing search functionality in text previews</p>

        <!-- Test 1: Search UI Visibility -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test 1: Search UI Visibility</h2>
            <p class="text-gray-600 mb-4">Search button should be visible for text files and hidden for other types</p>
            <button onclick="testSearchUIVisibility()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Run Test
            </button>
            <div id="test1-result" class="test-result hidden"></div>
        </div>

        <!-- Test 2: Search Functionality -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test 2: Search Functionality</h2>
            <p class="text-gray-600 mb-4">Search should find and highlight matches in text content</p>
            <button onclick="testSearchFunctionality()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Run Test
            </button>
            <div id="test2-result" class="test-result hidden"></div>
        </div>

        <!-- Test 3: Navigation Between Matches -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test 3: Navigation Between Matches</h2>
            <p class="text-gray-600 mb-4">Previous/Next buttons should navigate between search matches</p>
            <button onclick="testSearchNavigation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Run Test
            </button>
            <div id="test3-result" class="test-result hidden"></div>
        </div>

        <!-- Test 4: Match Count Display -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test 4: Match Count Display</h2>
            <p class="text-gray-600 mb-4">Match count should display "X of Y matches" format</p>
            <button onclick="testMatchCount()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Run Test
            </button>
            <div id="test4-result" class="test-result hidden"></div>
        </div>

        <!-- Test 5: Scroll to Match -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test 5: Scroll to Match</h2>
            <p class="text-gray-600 mb-4">Navigating to a match should scroll it into view</p>
            <button onclick="testScrollToMatch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Run Test
            </button>
            <div id="test5-result" class="test-result hidden"></div>
        </div>

        <!-- Manual Test: Interactive Search -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Manual Test: Interactive Search</h2>
            <p class="text-gray-600 mb-4">Open a text file preview and test search interactively</p>
            <button onclick="openTestPreview()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Open Test Preview
            </button>
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Manual Test Steps:</h3>
                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                    <li>Click "Open Test Preview" button</li>
                    <li>Click the search icon in the modal header</li>
                    <li>Type a search query (e.g., "test")</li>
                    <li>Verify matches are highlighted</li>
                    <li>Verify match count is displayed (e.g., "1 of 5")</li>
                    <li>Click next/previous buttons to navigate</li>
                    <li>Verify current match is highlighted differently</li>
                    <li>Verify page scrolls to show current match</li>
                    <li>Clear search and verify highlights are removed</li>
                </ol>
            </div>
        </div>
    </div>

    <script type="module">
        import { FilePreviewModal } from './src/main/resources/static/js/file-preview-modal.js';
        import { TextRenderer } from './src/main/resources/static/js/text-renderer.js';

        // Make classes available globally for tests
        window.FilePreviewModal = FilePreviewModal;
        window.TextRenderer = TextRenderer;

        // Test 1: Search UI Visibility
        window.testSearchUIVisibility = async function() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.classList.remove('hidden');
            
            try {
                // Create mock text content
                const mockContent = 'This is test content.\nIt has multiple lines.\nWe can search in this content.';
                
                // Create a text renderer
                const renderer = new TextRenderer();
                renderer.currentContent = mockContent;
                
                // Create modal
                const modal = new FilePreviewModal();
                
                // Simulate opening with text file
                await modal.open(1, 'test.txt', 'text/plain');
                
                // Check if search button is visible
                const searchButton = document.querySelector('#preview-search-toggle');
                const isVisible = searchButton && !searchButton.classList.contains('hidden');
                
                if (isVisible) {
                    resultDiv.textContent = '✓ PASS: Search button is visible for text files';
                    resultDiv.className = 'test-result test-pass';
                } else {
                    resultDiv.textContent = '✗ FAIL: Search button is not visible';
                    resultDiv.className = 'test-result test-fail';
                }
                
                // Clean up
                modal.close();
            } catch (error) {
                resultDiv.textContent = `✗ FAIL: ${error.message}`;
                resultDiv.className = 'test-result test-fail';
            }
        };

        // Test 2: Search Functionality
        window.testSearchFunctionality = function() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.classList.remove('hidden');
            
            try {
                const mockContent = 'This is test content.\nIt has multiple test occurrences.\nWe can test search functionality.';
                
                const renderer = new TextRenderer();
                renderer.currentContent = mockContent;
                renderer.currentLines = mockContent.split('\n');
                
                // Perform search
                const matchCount = renderer.search('test');
                
                if (matchCount === 3) {
                    resultDiv.textContent = `✓ PASS: Found ${matchCount} matches for "test"`;
                    resultDiv.className = 'test-result test-pass';
                } else {
                    resultDiv.textContent = `✗ FAIL: Expected 3 matches, found ${matchCount}`;
                    resultDiv.className = 'test-result test-fail';
                }
            } catch (error) {
                resultDiv.textContent = `✗ FAIL: ${error.message}`;
                resultDiv.className = 'test-result test-fail';
            }
        };

        // Test 3: Navigation Between Matches
        window.testSearchNavigation = function() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.classList.remove('hidden');
            
            try {
                const mockContent = 'First test. Second test. Third test.';
                
                const renderer = new TextRenderer();
                renderer.currentContent = mockContent;
                renderer.currentLines = mockContent.split('\n');
                
                // Perform search
                renderer.search('test');
                
                // Get first match
                const match1 = renderer.getCurrentMatch();
                
                // Navigate to next
                renderer.nextMatch();
                const match2 = renderer.getCurrentMatch();
                
                // Navigate to next again
                renderer.nextMatch();
                const match3 = renderer.getCurrentMatch();
                
                // Navigate to previous
                renderer.previousMatch();
                const match2Again = renderer.getCurrentMatch();
                
                if (match1.index === 0 && match2.index === 1 && match3.index === 2 && match2Again.index === 1) {
                    resultDiv.textContent = '✓ PASS: Navigation between matches works correctly';
                    resultDiv.className = 'test-result test-pass';
                } else {
                    resultDiv.textContent = '✗ FAIL: Navigation indices incorrect';
                    resultDiv.className = 'test-result test-fail';
                }
            } catch (error) {
                resultDiv.textContent = `✗ FAIL: ${error.message}`;
                resultDiv.className = 'test-result test-fail';
            }
        };

        // Test 4: Match Count Display
        window.testMatchCount = function() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.classList.remove('hidden');
            
            try {
                const mockContent = 'apple banana apple cherry apple';
                
                const renderer = new TextRenderer();
                renderer.currentContent = mockContent;
                renderer.currentLines = mockContent.split('\n');
                
                // Perform search
                const matchCount = renderer.search('apple');
                const currentMatch = renderer.getCurrentMatch();
                
                if (matchCount === 3 && currentMatch.total === 3 && currentMatch.index === 0) {
                    resultDiv.textContent = `✓ PASS: Match count displays correctly (${currentMatch.index + 1} of ${currentMatch.total})`;
                    resultDiv.className = 'test-result test-pass';
                } else {
                    resultDiv.textContent = `✗ FAIL: Match count incorrect`;
                    resultDiv.className = 'test-result test-fail';
                }
            } catch (error) {
                resultDiv.textContent = `✗ FAIL: ${error.message}`;
                resultDiv.className = 'test-result test-fail';
            }
        };

        // Test 5: Scroll to Match (simulated)
        window.testScrollToMatch = function() {
            const resultDiv = document.getElementById('test5-result');
            resultDiv.classList.remove('hidden');
            
            try {
                // Create large content with matches at different positions
                let mockContent = '';
                for (let i = 0; i < 100; i++) {
                    mockContent += `Line ${i}: ${i % 10 === 0 ? 'MATCH' : 'content'}\n`;
                }
                
                const renderer = new TextRenderer();
                renderer.currentContent = mockContent;
                renderer.currentLines = mockContent.split('\n');
                
                // Perform search
                const matchCount = renderer.search('MATCH');
                
                // Get first match line
                const firstMatch = renderer.getCurrentMatch();
                
                // Navigate to last match
                for (let i = 0; i < matchCount - 1; i++) {
                    renderer.nextMatch();
                }
                const lastMatch = renderer.getCurrentMatch();
                
                if (firstMatch.line === 0 && lastMatch.line === 90) {
                    resultDiv.textContent = '✓ PASS: Match line numbers calculated correctly for scrolling';
                    resultDiv.className = 'test-result test-pass';
                } else {
                    resultDiv.textContent = `✗ FAIL: Line numbers incorrect (first: ${firstMatch.line}, last: ${lastMatch.line})`;
                    resultDiv.className = 'test-result test-fail';
                }
            } catch (error) {
                resultDiv.textContent = `✗ FAIL: ${error.message}`;
                resultDiv.className = 'test-result test-fail';
            }
        };

        // Manual test: Open preview with search
        window.openTestPreview = async function() {
            // Create sample text content
            const sampleText = `File Preview System - Search Test Document

This is a test document for the search functionality.
The word "test" appears multiple times in this document.
You can test the search by typing "test" in the search box.

Features to test:
1. Search input field appears when clicking search icon
2. Matches are highlighted as you type
3. Match count shows "X of Y matches"
4. Previous/Next buttons navigate between matches
5. Current match is highlighted differently
6. Page scrolls to show current match
7. Clear button removes all highlights

Additional test content:
Lorem ipsum dolor sit amet, consectetur adipiscing elit.
Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco.
Laboris nisi ut aliquip ex ea commodo consequat.

More test occurrences:
- First test
- Second test  
- Third test
- Fourth test
- Fifth test

End of test document.`;

            // Mock the fetch API for this test
            const originalFetch = window.fetch;
            window.fetch = async function(url) {
                if (url.includes('/metadata')) {
                    return {
                        ok: true,
                        json: async () => ({
                            success: true,
                            data: {
                                id: 1,
                                fileName: 'test-document.txt',
                                mimeType: 'text/plain',
                                fileSize: sampleText.length,
                                uploadDate: new Date().toISOString(),
                                uploaderName: 'Test User',
                                departmentName: 'Test Department'
                            }
                        })
                    };
                } else if (url.includes('/content')) {
                    return {
                        ok: true,
                        json: async () => ({
                            success: true,
                            data: sampleText
                        })
                    };
                }
                return originalFetch(url);
            };

            // Create and open modal
            const modal = new FilePreviewModal();
            await modal.open(1, 'test-document.txt', 'text/plain');

            // Restore original fetch after a delay
            setTimeout(() => {
                window.fetch = originalFetch;
            }, 1000);
        };
    </script>
</body>
</html>
