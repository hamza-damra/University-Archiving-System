<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dean Dashboard - Unit Tests</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .test-pass { color: #10B981; }
        .test-fail { color: #EF4444; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #E5E7EB; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Dean Dashboard - Unit Tests</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Summary</h2>
            <div id="test-summary" class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="total-tests">0</div>
                    <div class="text-sm text-gray-600">Total Tests</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="passed-tests">0</div>
                    <div class="text-sm text-gray-600">Passed</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-600" id="failed-tests">0</div>
                    <div class="text-sm text-gray-600">Failed</div>
                </div>
            </div>
        </div>

        <div id="test-results"></div>

        <button onclick="runAllTests()" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
            Run All Tests
        </button>
    </div>

    <script type="module">
        // Simple test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = { total: 0, passed: 0, failed: 0 };
            }

            describe(suiteName, testFn) {
                const suite = { name: suiteName, tests: [] };
                this.currentSuite = suite;
                testFn();
                this.tests.push(suite);
                this.currentSuite = null;
            }

            it(testName, testFn) {
                if (!this.currentSuite) {
                    throw new Error('it() must be called within describe()');
                }
                this.currentSuite.tests.push({ name: testName, fn: testFn });
            }

            async runAll() {
                this.results = { total: 0, passed: 0, failed: 0 };
                const resultsContainer = document.getElementById('test-results');
                resultsContainer.innerHTML = '';

                for (const suite of this.tests) {
                    const suiteDiv = document.createElement('div');
                    suiteDiv.className = 'test-section';
                    suiteDiv.innerHTML = `<h3 class="text-lg font-semibold mb-3">${suite.name}</h3>`;
                    
                    const testsList = document.createElement('ul');
                    testsList.className = 'space-y-2';

                    for (const test of suite.tests) {
                        this.results.total++;
                        const testItem = document.createElement('li');
                        
                        try {
                            await test.fn();
                            this.results.passed++;
                            testItem.className = 'test-pass';
                            testItem.innerHTML = `✓ ${test.name}`;
                        } catch (error) {
                            this.results.failed++;
                            testItem.className = 'test-fail';
                            testItem.innerHTML = `✗ ${test.name}<br><span class="text-sm ml-4">${error.message}</span>`;
                        }
                        
                        testsList.appendChild(testItem);
                    }

                    suiteDiv.appendChild(testsList);
                    resultsContainer.appendChild(suiteDiv);
                }

                this.updateSummary();
            }

            updateSummary() {
                document.getElementById('total-tests').textContent = this.results.total;
                document.getElementById('passed-tests').textContent = this.results.passed;
                document.getElementById('failed-tests').textContent = this.results.failed;
            }
        }

        // Assertion helpers
        function expect(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${expected} but got ${actual}`);
                    }
                },
                toEqual(expected) {
                    if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                        throw new Error(`Expected ${JSON.stringify(expected)} but got ${JSON.stringify(actual)}`);
                    }
                },
                toBeTruthy() {
                    if (!actual) {
                        throw new Error(`Expected truthy value but got ${actual}`);
                    }
                },
                toBeFalsy() {
                    if (actual) {
                        throw new Error(`Expected falsy value but got ${actual}`);
                    }
                },
                toContain(item) {
                    if (!actual.includes(item)) {
                        throw new Error(`Expected array to contain ${item}`);
                    }
                },
                toBeGreaterThan(value) {
                    if (actual <= value) {
                        throw new Error(`Expected ${actual} to be greater than ${value}`);
                    }
                }
            };
        }

        const runner = new TestRunner();

        // Test Suite 1: Analytics Data Transformation
        runner.describe('Analytics Data Transformation', () => {
            runner.it('should transform submission trends data correctly', () => {
                const rawData = [
                    { date: '2025-11-21', count: 15 },
                    { date: '2025-11-22', count: 20 }
                ];
                
                const transformed = {
                    labels: rawData.map(d => d.date),
                    datasets: [{
                        data: rawData.map(d => d.count)
                    }]
                };
                
                expect(transformed.labels.length).toBe(2);
                expect(transformed.datasets[0].data[0]).toBe(15);
            });

            runner.it('should calculate compliance percentage correctly', () => {
                const totalCourses = 25;
                const compliantCourses = 20;
                const percentage = Math.round((compliantCourses / totalCourses) * 100);
                
                expect(percentage).toBe(80);
            });

            runner.it('should handle empty analytics data', () => {
                const rawData = [];
                const transformed = {
                    labels: rawData.map(d => d.date),
                    datasets: [{ data: rawData.map(d => d.count) }]
                };
                
                expect(transformed.labels.length).toBe(0);
                expect(transformed.datasets[0].data.length).toBe(0);
            });
        });

        // Test Suite 2: Filter Logic
        runner.describe('Filter Logic', () => {
            runner.it('should filter by single department', () => {
                const data = [
                    { id: 1, department: 'CS' },
                    { id: 2, department: 'Math' },
                    { id: 3, department: 'CS' }
                ];
                
                const filtered = data.filter(item => item.department === 'CS');
                expect(filtered.length).toBe(2);
            });

            runner.it('should filter by multiple departments', () => {
                const data = [
                    { id: 1, department: 'CS' },
                    { id: 2, department: 'Math' },
                    { id: 3, department: 'Physics' }
                ];
                
                const selectedDepts = ['CS', 'Math'];
                const filtered = data.filter(item => selectedDepts.includes(item.department));
                expect(filtered.length).toBe(2);
            });

            runner.it('should filter by date range', () => {
                const data = [
                    { id: 1, date: '2025-11-20' },
                    { id: 2, date: '2025-11-21' },
                    { id: 3, date: '2025-11-22' }
                ];
                
                const startDate = '2025-11-21';
                const endDate = '2025-11-22';
                const filtered = data.filter(item => item.date >= startDate && item.date <= endDate);
                expect(filtered.length).toBe(2);
            });

            runner.it('should combine multiple filters', () => {
                const data = [
                    { id: 1, department: 'CS', date: '2025-11-20' },
                    { id: 2, department: 'Math', date: '2025-11-21' },
                    { id: 3, department: 'CS', date: '2025-11-21' }
                ];
                
                const filtered = data.filter(item => 
                    item.department === 'CS' && item.date === '2025-11-21'
                );
                expect(filtered.length).toBe(1);
                expect(filtered[0].id).toBe(3);
            });
        });

        // Test Suite 3: Export Functions
        runner.describe('Export Functions', () => {
            runner.it('should generate timestamped filename', () => {
                const prefix = 'report';
                const format = 'pdf';
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${prefix}_${timestamp}.${format}`;
                
                expect(filename).toContain(prefix);
                expect(filename).toContain(format);
            });

            runner.it('should format export data correctly', () => {
                const data = [
                    { name: 'John', email: 'john@example.com', status: 'Active' }
                ];
                
                const formatted = data.map(row => ({
                    Name: row.name,
                    Email: row.email,
                    Status: row.status
                }));
                
                expect(formatted[0].Name).toBe('John');
                expect(formatted[0].Email).toBe('john@example.com');
            });

            runner.it('should include metadata in export', () => {
                const metadata = {
                    generatedBy: 'Dean Name',
                    generatedAt: new Date().toISOString(),
                    filters: { semester: 'First' }
                };
                
                expect(metadata.generatedBy).toBeTruthy();
                expect(metadata.generatedAt).toBeTruthy();
                expect(metadata.filters).toBeTruthy();
            });
        });

        // Test Suite 4: State Management
        runner.describe('State Management', () => {
            runner.it('should initialize state correctly', () => {
                const state = {
                    currentTab: 'dashboard',
                    sidebarCollapsed: false,
                    selectedRows: [],
                    filters: {}
                };
                
                expect(state.currentTab).toBe('dashboard');
                expect(state.sidebarCollapsed).toBe(false);
                expect(state.selectedRows.length).toBe(0);
            });

            runner.it('should update state correctly', () => {
                const state = { currentTab: 'dashboard' };
                state.currentTab = 'professors';
                
                expect(state.currentTab).toBe('professors');
            });

            runner.it('should manage selected rows', () => {
                const selectedRows = [];
                selectedRows.push(1, 2, 3);
                
                expect(selectedRows.length).toBe(3);
                expect(selectedRows).toContain(2);
            });

            runner.it('should clear selection', () => {
                let selectedRows = [1, 2, 3];
                selectedRows = [];
                
                expect(selectedRows.length).toBe(0);
            });
        });

        // Test Suite 5: Utility Functions
        runner.describe('Utility Functions', () => {
            runner.it('should format file size correctly', () => {
                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
                
                expect(formatFileSize(1024)).toBe('1 KB');
                expect(formatFileSize(1048576)).toBe('1 MB');
            });

            runner.it('should generate user initials', () => {
                function getInitials(name) {
                    const parts = name.trim().split(' ');
                    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
                    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
                }
                
                expect(getInitials('John Doe')).toBe('JD');
                expect(getInitials('Ahmed')).toBe('A');
            });

            runner.it('should format relative time', () => {
                function getRelativeTime(date) {
                    const now = new Date();
                    const diff = Math.floor((now - new Date(date)) / 1000);
                    
                    if (diff < 60) return 'just now';
                    if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
                    if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
                    return `${Math.floor(diff / 86400)} days ago`;
                }
                
                const result = getRelativeTime(new Date());
                expect(result).toBe('just now');
            });

            runner.it('should validate email format', () => {
                function isValidEmail(email) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                }
                
                expect(isValidEmail('test@example.com')).toBeTruthy();
                expect(isValidEmail('invalid-email')).toBeFalsy();
            });
        });

        // Make runner available globally
        window.testRunner = runner;
        window.runAllTests = () => runner.runAll();

        // Auto-run tests on load
        window.addEventListener('load', () => {
            runner.runAll();
        });
    </script>
</body>
</html>
