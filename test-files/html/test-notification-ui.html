<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification UI Test</title>
    <link rel="stylesheet" href="src/main/resources/static/css/common.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .test-header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .test-content {
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #111827;
        }
        
        .test-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .test-btn:hover {
            background: #2563eb;
        }
        
        .test-btn.secondary {
            background: #6b7280;
        }
        
        .test-btn.secondary:hover {
            background: #4b5563;
        }
        
        .log-output {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.success { background: #10b981; }
        .status-indicator.error { background: #ef4444; }
        .status-indicator.pending { background: #f59e0b; }
    </style>
</head>
<body>
    <!-- Test Header with Notification UI -->
    <header class="test-header">
        <div class="header-title">Notification UI Test Page</div>
        <div class="header-user">
            <!-- Notification will be inserted here -->
            <span>Test User</span>
        </div>
    </header>
    
    <div class="test-content">
        <div class="test-section">
            <h2>Notification UI Test</h2>
            <p>This page tests the notification UI component for Dean and HOD dashboards.</p>
            
            <h3>Test Actions</h3>
            <button class="test-btn" onclick="initNotifications('deanship')">Init as Dean</button>
            <button class="test-btn" onclick="initNotifications('hod')">Init as HOD</button>
            <button class="test-btn secondary" onclick="addMockNotification()">Add Mock Notification</button>
            <button class="test-btn secondary" onclick="clearLog()">Clear Log</button>
            
            <h3>Test Log</h3>
            <div id="logOutput" class="log-output">Ready for testing...</div>
        </div>
        
        <div class="test-section">
            <h2>Feature Checklist</h2>
            <ul>
                <li><span class="status-indicator pending" id="status-icon"></span> Notification bell icon in header</li>
                <li><span class="status-indicator pending" id="status-badge"></span> Unread count badge</li>
                <li><span class="status-indicator pending" id="status-dropdown"></span> Dropdown with notifications</li>
                <li><span class="status-indicator pending" id="status-markread"></span> Mark as read functionality</li>
                <li><span class="status-indicator pending" id="status-markall"></span> Mark all as read button</li>
                <li><span class="status-indicator pending" id="status-polling"></span> Polling for new notifications</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>API Endpoints</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <th style="text-align: left; padding: 8px;">Endpoint</th>
                    <th style="text-align: left; padding: 8px;">Method</th>
                    <th style="text-align: left; padding: 8px;">Description</th>
                </tr>
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 8px; font-family: monospace;">/api/{role}/notifications</td>
                    <td style="padding: 8px;">GET</td>
                    <td style="padding: 8px;">Get all notifications for current user</td>
                </tr>
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 8px; font-family: monospace;">/api/{role}/notifications/unread-count</td>
                    <td style="padding: 8px;">GET</td>
                    <td style="padding: 8px;">Get unread notification count</td>
                </tr>
                <tr>
                    <td style="padding: 8px; font-family: monospace;">/api/{role}/notifications/{id}/read</td>
                    <td style="padding: 8px;">PUT</td>
                    <td style="padding: 8px;">Mark notification as read</td>
                </tr>
            </table>
        </div>
    </div>
    
    <script src="src/main/resources/static/js/notifications.js"></script>
    <script>
        let mockNotifications = [];
        let mockUnreadCount = 0;
        
        function log(message) {
            const output = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `\n[${timestamp}] ${message}`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logOutput').textContent = 'Log cleared...';
        }
        
        function updateStatus(id, status) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = `status-indicator ${status}`;
            }
        }
        
        function initNotifications(role) {
            log(`Initializing NotificationManager for role: ${role}`);
            
            // Mock the fetch API for testing
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                log(`API Call: ${options?.method || 'GET'} ${url}`);
                
                if (url.includes('/notifications/unread-count')) {
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({ success: true, data: mockUnreadCount })
                    });
                }
                
                if (url.includes('/notifications') && url.includes('/read')) {
                    const id = parseInt(url.match(/\/notifications\/(\d+)\/read/)?.[1]);
                    const notification = mockNotifications.find(n => n.id === id);
                    if (notification && !notification.seen) {
                        notification.seen = true;
                        mockUnreadCount = Math.max(0, mockUnreadCount - 1);
                    }
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({ success: true, data: 'Success' })
                    });
                }
                
                if (url.includes('/notifications')) {
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({ success: true, data: mockNotifications })
                    });
                }
                
                return originalFetch(url, options);
            };
            
            // Set mock token
            localStorage.setItem('token', 'mock-token-for-testing');
            
            // Initialize
            NotificationManager.init(role);
            
            log('NotificationManager initialized');
            updateStatus('status-icon', 'success');
            updateStatus('status-dropdown', 'success');
            updateStatus('status-polling', 'success');
            
            // Add some mock notifications
            addMockNotification();
            addMockNotification();
            addMockNotification();
        }
        
        function addMockNotification() {
            const id = mockNotifications.length + 1;
            const notification = {
                id: id,
                title: `New Document Submission #${id}`,
                message: `Professor John Doe submitted a document for CS101 (Computer Science) at ${new Date().toISOString()}`,
                seen: false,
                type: 'DOCUMENT_SUBMITTED',
                relatedEntityId: id,
                relatedEntityType: 'DocumentSubmission',
                createdAt: new Date(Date.now() - Math.random() * 86400000).toISOString()
            };
            
            mockNotifications.unshift(notification);
            mockUnreadCount++;
            
            log(`Added mock notification #${id}`);
            updateStatus('status-badge', 'success');
            
            // Refresh the notification manager
            if (NotificationManager.state.notifications) {
                NotificationManager.loadNotifications();
            }
        }
        
        // Test mark as read
        document.addEventListener('click', function(e) {
            if (e.target.closest('.notification-item')) {
                log('Notification clicked - marking as read');
                updateStatus('status-markread', 'success');
            }
            if (e.target.closest('.mark-all-read-btn')) {
                log('Mark all as read clicked');
                updateStatus('status-markall', 'success');
            }
        });
        
        log('Test page loaded. Click "Init as Dean" or "Init as HOD" to start testing.');
    </script>
</body>
</html>
